<!-- 
  Storage Calculator Widget - Reusable Component
  Alpine.js driven, calls StorageCalculator.js for math
  Supports: Video, Photo, Continuous, Reverse modes
-->

<div x-data="calculatorState" class="calculator-widget py-8">
    <!-- Layer 1: Use Case Selection -->
    <div x-show="currentLayer === 'usecase'" class="animate-fade">
        <div class="mb-6">
            <button @click="reset()" x-show="hasCalculated"
                class="text-sm px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition">
                ‚Üê Change Scenario
            </button>
        </div>

        <h3 class="text-xl font-bold mb-6">What are you recording?</h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button @click="selectUseCase('video')"
                class="p-6 border-2 border-gray-300 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition text-center">
                <div class="text-4xl mb-2">üé•</div>
                <h4 class="font-bold text-lg">Video Recording</h4>
                <p class="text-sm text-gray-600">4K, 1080p, any bitrate</p>
            </button>

            <button @click="selectUseCase('photo')"
                class="p-6 border-2 border-gray-300 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition text-center">
                <div class="text-4xl mb-2">üì∏</div>
                <h4 class="font-bold text-lg">Photo Burst</h4>
                <p class="text-sm text-gray-600">JPEG, RAW, timelapse</p>
            </button>

            <button @click="selectUseCase('continuous')"
                class="p-6 border-2 border-gray-300 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition text-center">
                <div class="text-4xl mb-2">üî¥</div>
                <h4 class="font-bold text-lg">Continuous</h4>
                <p class="text-sm text-gray-600">24/7, dashcam, surveillance</p>
            </button>
        </div>
    </div>

    <!-- Layer 2: Scenario Details (Forward) -->
    <div x-show="currentLayer === 'details' && mode === 'forward'" class="animate-fade">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">
                <span x-text="scenarios[activeScenario].name"></span>
            </h3>
            <button @click="toggleMode()" class="text-sm px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition"
                title="Switch to: I have a card, how long can I record?">
                ‚ÜîÔ∏è Reverse
            </button>
        </div>

        <!-- Video Mode -->
        <div x-show="activeScenario === 'video'" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold mb-2">Resolution</label>
                    <select x-model="forward.video.resolution"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <template x-for="res in readonly.resolutions" :key="res">
                            <option :value="res" x-text="res"></option>
                        </template>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2">Frame Rate</label>
                    <select x-model.number="forward.video.fps"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <template x-for="fps in readonly.fpsOptions" :key="fps">
                            <option :value="fps" x-text="`${fps}fps`"></option>
                        </template>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2">Codec</label>
                    <select x-model="forward.video.codec" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <template x-for="codec in readonly.codecOptions" :key="codec">
                            <option :value="codec" x-text="codec"></option>
                        </template>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2">
                        Bitrate (Mbps)
                        <button type="button"
                            class="inline-block ml-1 text-blue-600 hover:text-blue-800 cursor-help font-normal"
                            aria-label="Bitrate help" title="Higher bitrate = better quality but larger files. Lower bitrate = smaller files but lower quality.">
                            ‚ÑπÔ∏è
                        </button>
                    </label>
                    <input x-model.number="forward.video.bitrateMbps" type="number" placeholder="150" min="1" step="1"
                        @input="validateNumericInput($event, 1)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        aria-label="Video bitrate in Mbps" aria-describedby="bitrate-help" />
                    <p id="bitrate-help" class="text-xs text-gray-600 mt-1">Standard: 50 Mbps for 1080p, 100-150 Mbps for 4K. Not sure? Start with 150 Mbps for good quality.</p>
                </div>
            </div>

            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <label class="block text-sm font-bold mb-2">Recording Duration</label>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs text-gray-600">Hours</label>
                        <input x-model.number="forward.video.durationHours" type="number" placeholder="2" min="0"
                            step="1" @input="validateNumericInput($event, 0, 999)"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            aria-label="Recording duration in hours" />
                    </div>
                    <div>
                        <label class="text-xs text-gray-600">Minutes</label>
                        <input x-model.number="forward.video.durationMinutes" type="number" placeholder="0" min="0"
                            max="59" step="1" @input="validateNumericInput($event, 0, 59)"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            aria-label="Recording duration in minutes" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Photo Mode -->
        <div x-show="activeScenario === 'photo'" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold mb-2">Total Photos</label>
                    <input x-model.number="forward.photo.photoCount" type="number" placeholder="1000" min="1" step="1"
                        @input="validateNumericInput($event, 1)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        aria-label="Total number of photos to store" />
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2">File Size per Photo (MB)</label>
                    <input x-model.number="forward.photo.fileSizeMB" type="number" step="0.1" placeholder="2.5"
                        min="0.1" @input="validateNumericInput($event, 0.1)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        aria-label="File size per photo in megabytes" />
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2">
                        Burst Rate
                        <button type="button"
                            class="inline-block ml-1 text-blue-600 hover:text-blue-800 cursor-help font-normal"
                            aria-label="Burst rate help" title="How fast you're shooting affects the card speed you'll need">
                            ‚ÑπÔ∏è
                        </button>
                    </label>
                    <select x-model="forward.photo.shootingStyle"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        aria-label="Photo burst rate in frames per second">
                        <option value="casual">Casual - 2-5 fps (slow shooting)</option>
                        <option value="normal">Normal - 10 fps (typical burst)</option>
                        <option value="highspeed">High-Speed - 20+ fps (rapid fire)</option>
                    </select>
                </div>
            </div>

            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <label class="flex items-center">
                    <input type="checkbox" @change="toggleRaw()" :checked="forward.photo.isRaw" class="mr-2" />
                    <span class="text-sm font-bold">RAW Format</span>
                </label>
                <p class="text-xs text-gray-600 mt-2">
                    <span x-text="forward.photo.isRaw ? 'RAW (uncompressed)' : 'JPEG (compressed)'"></span>
                    - File size updated
                </p>
            </div>

            <div class="text-xs text-gray-600 p-3 bg-gray-100 rounded">
                <strong>Quick presets:</strong>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <button @click="updatePhotoFileSize('jpeg5mp')" class="text-left hover:text-blue-600">
                        ‚Üí 5MP JPEG (2.5MB)
                    </button>
                    <button @click="updatePhotoFileSize('jpeg20mp')" class="text-left hover:text-blue-600">
                        ‚Üí 20MP JPEG (8MB)
                    </button>
                    <button @click="updatePhotoFileSize('raw20mp')" class="text-left hover:text-blue-600">
                        ‚Üí 20MP RAW (30MB)
                    </button>
                    <button @click="updatePhotoFileSize('raw45mp')" class="text-left hover:text-blue-600">
                        ‚Üí 45MP RAW (65MB)
                    </button>
                </div>
            </div>
        </div>

        <!-- Continuous Mode -->
        <div x-show="activeScenario === 'continuous'" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-bold mb-2">Bitrate (Mbps)</label>
                    <input x-model.number="forward.continuous.bitrateMbps" type="number" placeholder="5" min="1"
                        step="0.1" @input="validateNumericInput($event, 1)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        aria-label="Continuous recording bitrate in Mbps" />
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2">Hours per Day</label>
                    <input x-model.number="forward.continuous.hoursPerDay" type="number" placeholder="24" min="0"
                        max="24" step="1" @input="validateNumericInput($event, 0, 24)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        aria-label="Hours of recording per day" />
                </div>

                <div>
                    <label class="block text-sm font-bold mb-2">Days Needed</label>
                    <input x-model.number="forward.continuous.daysNeeded" type="number" placeholder="7" min="1" step="1"
                        @input="validateNumericInput($event, 1)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        aria-label="Number of days continuous recording is needed" />
                </div>
            </div>

            <div class="p-3 bg-amber-50 border border-amber-200 rounded text-amber-900 text-xs">
                <strong>‚ö†Ô∏è Important:</strong> For continuous recording, use <strong>HIGH_ENDURANCE</strong> cards (designed for 24/7 use). Regular V30/V60 cards will fail quickly.
            </div>
        </div>

        <!-- Advanced Options (All Modes) -->
        <div class="mt-6 border border-gray-300 rounded-lg overflow-hidden">
            <button type="button" @click="advancedExpanded = !advancedExpanded" :aria-expanded="advancedExpanded"
                aria-controls="advanced-content"
                class="w-full cursor-pointer font-bold text-sm py-2 px-4 hover:bg-gray-100 text-left flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition">
                <span>‚öôÔ∏è Advanced Options</span>
                <span :class="advancedExpanded ? 'rotate-180' : ''" class="transition-transform">‚ñº</span>
            </button>

            <div id="advanced-content" class="p-4 space-y-4" x-show="advancedExpanded" @click.outside="advancedExpanded = false">
                <div>
                    <label class="block text-sm font-bold mb-2">
                        Overhead Buffer: <span x-text="`${forward.overheadPercent}%`"></span>
                    </label>
                    <input type="range" x-model.number="forward.overheadPercent" :min="forward.overheadMin"
                        :max="forward.overheadMax" step="1" class="w-full" aria-label="Overhead buffer percentage"
                        aria-valuemin="5" aria-valuemax="25" />
                    <p class="text-xs text-gray-600 mt-2">
                        Add buffer for metadata, camera system files, and write inefficiency
                    </p>
                </div>

                <label class="flex items-center">
                    <input type="checkbox" x-model="forward.compareFormats" class="mr-2"
                        aria-label="Compare H.264, H.265, and ProRes file sizes" />
                    <span class="text-sm font-bold">Compare H.264 vs H.265 vs ProRes</span>
                </label>
            </div>
        </div>

        <!-- Calculate Button -->
        <button @click="calculate()" :disabled="!isInputValid()"
            class="mt-6 w-full px-4 py-3 h-12 bg-orange-500 text-white font-bold rounded-lg hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition">
            Calculate Storage Needed
        </button>
    </div>

    <!-- Layer 2: Scenario Details (Reverse) -->
    <div x-show="currentLayer === 'details' && mode === 'reverse'" class="animate-fade" 
         x-effect="if (currentLayer === 'details' && mode === 'reverse') { initCardSelector(); }">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">
                I have a card ‚Äî how long can I record?
            </h3>
            <button @click="toggleMode()" class="text-sm px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition"
                title="Switch to: How much storage do I need?">
                ‚ÜîÔ∏è Forward
            </button>
        </div>

        <!-- Manual Input Fields -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-bold mb-2">Card Capacity (GB)</label>
                <select x-model.number="reverse.cardCapacityGB"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg" aria-label="Select SD card capacity">
                    <template x-for="cap in reverse.cardCapacityOptions" :key="cap">
                        <option :value="cap" x-text="`${cap}GB`"></option>
                    </template>
                </select>
            </div>

            <div x-show="activeScenario === 'photo'">
                <label class="block text-sm font-bold mb-2">File Size per Photo (MB)</label>
                <input x-model.number="reverse.photo.fileSizeMB" type="number" step="0.1" placeholder="2.5" min="0.1"
                    @input="validateNumericInput($event, 0.1)"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    aria-label="File size per photo in megabytes" />
            </div>

            <div x-show="activeScenario !== 'photo'">
                <label class="block text-sm font-bold mb-2">Bitrate (Mbps)</label>
                <input x-model.number="reverse.video.bitrateMbps" type="number" placeholder="150" min="1" step="1"
                    @input="validateNumericInput($event, 1)" class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    aria-label="Video bitrate in Mbps" />
            </div>
        </div>

        <!-- Card Selector (Below manual inputs) -->
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg" @click.away="cardSelectorOpen = false">
            <label class="block text-sm font-bold mb-3">üìã Or select a card from our database:</label>
            <div class="relative">
                <input type="text" x-model="cardSelectorSearch" @input="filterCardsList()" @click="cardSelectorOpen = true" @focus="cardSelectorOpen = true"
                    placeholder="Search by card name, speed class, type..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-600"
                    aria-label="Search cards database" aria-autocomplete="list" :aria-expanded="cardSelectorOpen" />
                
                <!-- Dropdown Menu -->
                <div x-show="cardSelectorOpen && allCards.length > 0" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto">
                    <!-- Cards List -->
                    <ul x-show="filteredCards.length > 0" role="listbox">
                        <template x-for="card in filteredCards.slice(0, 10)" :key="card.id">
                            <li>
                                <button type="button" @click="selectCard(card)"
                                    class="w-full text-left px-4 py-2 hover:bg-blue-50 border-b border-gray-100 focus:outline-none focus:bg-blue-100"
                                    role="option">
                                    <div class="font-bold text-sm" x-text="card.name"></div>
                                    <div class="text-xs text-gray-600">
                                        <span x-text="`${card.speed} ‚Ä¢ ${card.writeSpeed}`"></span>
                                        <span x-show="card.type" x-text="`‚Ä¢ ${card.type}`"></span>
                                    </div>
                                </button>
                            </li>
                        </template>
                    </ul>
                    
                    <!-- No Results Message -->
                    <div x-show="filteredCards.length === 0 && cardSelectorSearch" class="px-4 py-3 text-sm text-gray-500">No cards found</div>
                    
                    <!-- Loading Message -->
                    <div x-show="allCards.length === 0 && !cardSelectorSearch" class="px-4 py-3 text-sm text-gray-600">
                      <span class="animate-spin inline-block mr-2">‚ü≥</span> Loading cards...
                    </div>
                </div>
            </div>
            <p class="text-xs text-gray-600 mt-2">Start typing to search, or click to see all cards. Selecting a card will auto-fill bitrate.</p>
        </div>

        <button @click="calculateReverse()" :disabled="!isReverseInputValid()"
            class="w-full px-4 py-3 h-12 bg-orange-500 text-white font-bold rounded-lg hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition">
            Calculate Duration
        </button>
    </div>

    <!-- Layer 3: Results -->
    <div x-show="currentLayer === 'results'" class="animate-fade">
        <div class="mb-6">
            <button @click="currentLayer = 'details'"
                class="text-sm px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition">
                ‚Üê Back to Inputs
            </button>
        </div>

        <template x-if="result">
            <div>
                <!-- Forward Result Card -->
                <div x-show="mode === 'forward'" class="space-y-6">
                    <div class="p-6 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-2">You Need:</h3>
                        <div class="text-4xl font-bold mb-3">
                            <span x-text="`${result.recommendedCapacity}GB`"></span>
                            <span class="text-lg ml-2">Minimum</span>
                        </div>
                        <p class="text-blue-50">
                            <span x-text="`${result.totalGB}GB total storage`"></span><br>
                            <span class="text-sm text-blue-100"
                                x-text="`(${result.rawGB}GB footage + ${result.overheadGB}GB overhead)`"></span>
                        </p>
                    </div>

                    <div x-show="activeScenario === 'continuous' && forward.continuous.hoursPerDay >= 12"
                         class="p-4 bg-amber-50 border border-amber-200 rounded text-amber-900 text-sm">
                        <strong>‚ö†Ô∏è Important:</strong> For extended continuous recording, use <strong>HIGH_ENDURANCE</strong> cards (not speed cards). These are designed for 24/7 use and will last much longer.
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 border border-gray-300 rounded-lg">
                            <h4 class="font-bold text-sm text-gray-600 mb-2">Speed Class</h4>
                            <p class="text-2xl font-bold" x-text="`${result.speedClass}`"></p>
                            <p class="text-xs text-gray-600">Minimum for this bitrate</p>
                        </div>

                        <div class="p-4 border border-gray-300 rounded-lg">
                            <h4 class="font-bold text-sm text-gray-600 mb-2">Min Write Speed</h4>
                            <p class="text-2xl font-bold" x-text="`${result.minWriteSpeed} MB/s`"></p>
                            <p class="text-xs text-gray-600">Required write performance</p>
                        </div>
                    </div>

                    <button @click="reset()"
                        class="w-full px-4 py-2 border border-blue-600 text-blue-600 font-bold rounded-lg hover:bg-blue-50 transition h-10">
                        ‚Üê Calculate Another
                    </button>
                </div>

                <!-- Reverse Result Card -->
                <div x-show="mode === 'reverse'" class="space-y-6">
                    <div class="p-6 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-2">Your Card Duration:</h3>

                        <!-- Photo Result -->
                        <div x-show="activeScenario === 'photo'">
                            <div class="text-4xl font-bold mb-3">
                                <span x-text="`${result.photoCount.toLocaleString()}`"></span>
                                <span class="text-lg ml-2">Photos</span>
                            </div>
                            <p class="text-emerald-50">
                                On your <span x-text="`${reverse.cardCapacityGB}GB`"></span> card
                            </p>
                        </div>

                        <!-- Video/Continuous Result -->
                        <div x-show="activeScenario !== 'photo'">
                            <div class="text-4xl font-bold mb-3" x-text="`${result.recordingTimeString}`"></div>
                            <p class="text-emerald-50">
                                <span x-text="`${result.recordingHours} hours total`"></span><br>
                                <span class="text-sm text-emerald-100">For 24/7 continuous: <span
                                        x-text="`~${result.daysFor24h} days`"></span></span>
                            </p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 border border-gray-300 rounded-lg">
                            <h4 class="font-bold text-sm text-gray-600 mb-2">Speed Class</h4>
                            <p class="text-2xl font-bold" x-text="`${result.speedClass}`"></p>
                        </div>

                        <div class="p-4 border border-gray-300 rounded-lg">
                            <h4 class="font-bold text-sm text-gray-600 mb-2">Min Write Speed</h4>
                            <p class="text-2xl font-bold" x-text="`${result.minWriteSpeed} MB/s`"></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button @click="reset()"
                            class="px-4 py-2 border border-emerald-600 text-emerald-600 font-bold rounded-lg hover:bg-emerald-50 transition h-10">
                            Calculate Another
                        </button>
                        <a :href="`/sd-card-guide/`" target="_blank" rel="noopener noreferrer"
                            class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition h-10 flex items-center justify-center">
                            Learn More About Cards ‚Üó
                        </a>
                    </div>
                </div>

                <!-- Speed Class Reference Table -->
                <div class="mt-6 border border-gray-300 rounded-lg overflow-hidden">
                    <button type="button" @click="speedClassExpanded = !speedClassExpanded" :aria-expanded="speedClassExpanded"
                        aria-controls="speed-class-content"
                        class="w-full cursor-pointer font-bold text-sm py-2 px-4 hover:bg-gray-100 text-left flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition">
                        <span>üìä Speed Class Reference</span>
                        <span :class="speedClassExpanded ? 'rotate-180' : ''" class="transition-transform">‚ñº</span>
                    </button>

                    <div id="speed-class-content" class="p-4 overflow-x-auto" x-show="speedClassExpanded">
                        <table class="w-full text-sm" role="table">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left">Bitrate Range</th>
                                    <th class="px-4 py-2 text-left">Speed Class</th>
                                    <th class="px-4 py-2 text-left">Write Speed</th>
                                    <th class="px-4 py-2 text-left">Use Case</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="row in result.speedClassTable" :key="row.speedClass">
                                    <tr class="border-t">
                                        <td class="px-4 py-2" x-text="row.bitrateMbps"></td>
                                        <td class="px-4 py-2 font-bold" x-text="row.speedClass"></td>
                                        <td class="px-4 py-2" x-text="row.writeSpeed"></td>
                                        <td class="px-4 py-2 text-gray-600" x-text="row.useCase"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Card Recommendations Section -->
                <div id="calculator-recommendations" class="mt-8 p-6 bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg border border-orange-200">
                    <div class="text-center text-gray-600">
                        <span class="inline-block animate-spin mr-2">‚ü≥</span>
                        Loading recommendations...
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade {
        animation: fadeIn 0.3s ease-in-out;
    }
</style>
